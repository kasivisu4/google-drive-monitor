<!DOCTYPE html>
<html>

<head>
    <title>Google Drive Monitor</title>

    <meta charset="utf-8" />
</head>

<body>
    <h1 style="text-align: center;padding:20px">Google Drive Monitor</h1>
    <div style="padding:20px">
        <div style="display:flex;justify-content:space-around">
            <p>*This page helps you to monitor only files present in your google drive</p>
            <div>

                <div style="display: flex">
                    <label>Status: </label>
                    <div id="status" style="padding-left:10px"> Connected ðŸŸ¢</div>
                </div>
                <div style="padding:10px;padding-left:50px">
                    <button id="authorize_button" class="btn btn-primary"><a href='/' class="link-dark"
                            style='text-decoration: none;'>Disconnect</a></button>
                </div>
            </div>
        </div>
        <div id="driveDetails" style="white-space: pre-wrap;">
            <p id="details"></p>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        let driverDetails = document.querySelector('#driveDetails');

        async function getFiles(api) {


            let response = await fetch(api)
            let { files } = await response.json()


            // Create the table element
            let table = document.createElement("table");
            table.className = "table file-details";

            let header = document.createElement("thead");
            header.className = "thead-dark";


            // Create the table header row
            let headerRow = document.createElement("tr");

            let keys = ["name", "webContentLink", "permissions"]

            keys.map(key => {
                let th = document.createElement("th");
                th.scope = "col"
                th.textContent = key
                headerRow.appendChild(th);
            })

            header.appendChild(headerRow);

            // Append the header row to the table
            table.appendChild(header);

            let tbody = document.createElement("tbody");

            for (let i = 0; i < files.length; i++) {
                let rowData = files[i];

                // Create a new row
                let row = document.createElement("tr");

                keys.map(key => {
                    // Create the name cell
                    let td = document.createElement("td");
                    td.style = "max-width:400px;overflow-wrap: break-word"
                    if (key === "webContentLink") {
                        let a = document.createElement("a");
                        a.href = files[i][key] || "/"
                        a.innerText = "Download"
                        td.appendChild(a)
                        if (!files[i][key]) {
                            a.style = "visibility:hidden"
                        }
                    } else if (key === "permissions") {
                        td.textContent = files[i][key]?.map(d => d["emailAddress"]);
                    }
                    else {
                        td.textContent = files[i][key];

                    }
                    row.appendChild(td);
                })


                tbody.appendChild(row);
            }

            table.appendChild(tbody)

            // Append the table to the container
            driverDetails.appendChild(table);
        }
        getFiles("/list")
        let socket = io("https://google-drive-monitor.onrender.com");
        socket.on("re-render", async (message) => {
            let tables = Array.from(document.querySelectorAll('.table'))
            tables.forEach(d => d?.remove())
            console.log("Received rerender request")
            await getFiles("/updatedlist")
        });
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>

</body>

</html>